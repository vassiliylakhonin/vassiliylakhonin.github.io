name: Link Checks

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  internal-links:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate sitemap URLs map to local files
        run: |
          set -euo pipefail
          missing=0
          while IFS= read -r url; do
            [ -z "$url" ] && continue
            path="${url#https://vassiliylakhonin.github.io}"
            if [ -z "$path" ] || [ "$path" = "/" ]; then
              target="index.md"
            else
              target="${path#/}"
            fi
            if [ ! -f "$target" ]; then
              echo "Missing file for $url -> $target"
              missing=1
            fi
          done < <(sed -n 's:.*<loc>\(https://vassiliylakhonin.github.io[^<]*\)</loc>.*:\1:p' sitemap.xml)
          if [ "$missing" -ne 0 ]; then
            exit 1
          fi

      - name: Block old reporting sample URL
        run: |
          set -euo pipefail
          if rg -n "visionary-sunflower-a27912" .; then
            echo "Old reporting sample URL found. Replace with current URL."
            exit 1
          fi

  external-links:
    runs-on: ubuntu-latest
    needs: internal-links
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check external links
        uses: lycheeverse/lychee-action@v2
        with:
          fail: true
          args: >-
            --no-progress
            --accept 200,206,301,302,429
            --retry-wait-time 2
            --max-retries 2
            --exclude-mail
            --exclude https://www.linkedin.com/.*
            --exclude https://chatgpt.com/.*
            --exclude https://doi.org/.*
            --exclude https://humans.txt/.*
            --exclude http://humans.txt/.*
            --exclude https://humanstxt.org/.*
            ./index.md
            ./llms.txt
            ./services.html
            ./case-study-donor-reporting.html
            ./case-study-portfolio-audit-readiness.html
            ./case-study-saas-ecommerce-launch.html
            ./article-state-scholarships-digital-transformation.html
            ./article-data-overload-fitness-tracking.html
            ./article-regional-development-policy-analysis.html
            ./capabilities.json
            ./robots.txt
            ./sitemap.xml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
