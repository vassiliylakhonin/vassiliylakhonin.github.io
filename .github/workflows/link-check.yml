name: Link Checks

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  internal-links:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate sitemap URLs map to local files
        run: |
          set -euo pipefail
          missing=0
          while IFS= read -r url; do
            [ -z "$url" ] && continue
            path="${url#https://vassiliylakhonin.github.io}"
            if [ -z "$path" ] || [ "$path" = "/" ]; then
              target="index.md"
            else
              target="${path#/}"
            fi
            if [ ! -f "$target" ]; then
              echo "Missing file for $url -> $target"
              missing=1
            fi
          done < <(sed -n 's:.*<loc>\(https://vassiliylakhonin.github.io[^<]*\)</loc>.*:\1:p' sitemap.xml)
          if [ "$missing" -ne 0 ]; then
            exit 1
          fi

      - name: Block old reporting sample URL
        run: |
          set -euo pipefail
          if rg -n "visionary-sunflower-a27912" .; then
            echo "Old reporting sample URL found. Replace with current URL."
            exit 1
          fi
